<!DOCTYPE html>
<html lang="en" style="background: #000814;">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <!-- Critical CSS - Load First -->
    <style>
    html {
      background: #000814 !important;
    }
    body {
      background: transparent !important;
      min-height: 100vh !important;
      min-height: -webkit-fill-available !important;
      margin: 0 !important;
    }
  </style>

  <!-- Supabase loader for materials -->
  <script>
    const supabaseUrl = "https://bxeismfbqgsijzzkjrbp.supabase.co";
    const supabaseAnonKey = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImJ4ZWlzbWZicWdzaWp6emtqcmJwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjM2NTY4NzAsImV4cCI6MjA3OTIzMjg3MH0.LPo0253KUAipJ2dKWHN-RKjEnXJnvrJGQ_3ZMw0Dfw8";

    // Try loading a static /materials.json first (fast, no keys). If it
    // exists and contains data, use it. Otherwise fall back to Supabase.
    async function tryLoadStatic() {
      try {
        const res = await fetch('/materials.json', { cache: 'no-cache' });
        if (!res.ok) return false;
        const data = await res.json();
        if (data && Object.keys(data).length > 0) {
          allMaterials = data;
          setupFiltersAndSearch();
          displayMaterials(allMaterials);
          console.info('Loaded materials from /materials.json');
          return true;
        }
      } catch (err) {
        // ignore and fallback
      }
      return false;
    }

    // load supabase client if not already present
    function ensureSupabase() {
      if (typeof supabasejs === 'undefined') {
        const s = document.createElement('script');
        s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
        s.onload = initSupabase;
        document.head.appendChild(s);
      } else {
        initSupabase();
      }
    }

    let supabaseClient;
    const materialsList = document.getElementById("materials-list");
    const searchBar = document.getElementById("search-bar");
    const clearBtn = document.getElementById("clear-search");
    const filterButtons = document.querySelectorAll(".filter-btn");
    let allMaterials = {};
    let activeCategory = 'all';

    async function initSupabase() {
      try {
        supabaseClient = supabasejs.createClient(supabaseUrl, supabaseAnonKey);
        const ok = await loadFromSupabase();
        return ok;
      } catch (err) {
        console.error('Failed to initialize Supabase', err);
        showError('Failed to initialize Supabase', err);
        return false;
      }
    }

    // Kick off: try Supabase first, then static fallback
    (async function startLoader() {
      let loaded = false;
      if (typeof supabasejs !== 'undefined') {
        loaded = await initSupabase();
      } else {
        // load supabase script dynamically and init
        loaded = await new Promise((resolve) => {
          const s = document.createElement('script');
          s.src = 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2';
          s.onload = async () => { resolve(await initSupabase()); };
          s.onerror = () => { resolve(false); };
          document.head.appendChild(s);
        });
      }

      if (!loaded) {
        const staticLoaded = await tryLoadStatic();
        if (!staticLoaded) {
          showError('No materials found in Supabase or /materials.json');
        }
      }
    })();

    function showError(message, details) {
      console.error(message, details);
      materialsList.innerHTML = `<div class="no-results" style="padding:18px;background:rgba(255,255,255,0.03);border-radius:10px;"><p>âš ï¸ <strong>Error:</strong> ${message}</p><p style="opacity:0.85">Check console for details.</p></div>`;
    }

    async function loadFromSupabase() {
      try {
        const { data, error } = await supabaseClient.from('materials').select('*').order('id', { ascending: true });
        if (error) throw error;

        if (!data || data.length === 0) {
          return false; // nothing to show
        }

        // Group by subject
        const grouped = {};
        data.forEach(row => {
          const subject = row.subject || 'Other Materials';
          if (!grouped[subject]) grouped[subject] = [];
          grouped[subject].push({ name: row.title || (row.file_url || '').split('/').pop(), url: row.file_url });
        });

        allMaterials = grouped;
        setupFiltersAndSearch();
        displayMaterials(grouped);
        return true;
      } catch (err) {
        console.warn('Failed to load materials from Supabase', err && err.message);
        return false;
      }
    }

    function setupFiltersAndSearch() {
      filterButtons.forEach(btn => {
        btn.onclick = () => {
          filterButtons.forEach(b => b.classList.remove('active'));
          btn.classList.add('active');
          activeCategory = btn.dataset.category;
          searchBar.value = '';
          clearBtn.style.display = 'none';
          if (activeCategory === 'all') displayMaterials(allMaterials);
          else {
            const filtered = {};
            for (const s in allMaterials) if (s.includes(activeCategory)) filtered[s] = allMaterials[s];
            displayMaterials(filtered);
          }
        };
      });

      searchBar.oninput = (e) => {
        const q = e.target.value.toLowerCase().trim();
        clearBtn.style.display = q ? 'block' : 'none';
        if (q) { filterButtons.forEach(b => b.classList.remove('active')); filterButtons[0].classList.add('active'); activeCategory = 'all'; }
        filterMaterials(q);
      };

      clearBtn.onclick = () => { searchBar.value = ''; clearBtn.style.display = 'none'; filterMaterials(''); };
    }

    function filterMaterials(query) {
      if (!query) { if (activeCategory === 'all') displayMaterials(allMaterials); else { const filtered = {}; for (const s in allMaterials) if (s.includes(activeCategory)) filtered[s] = allMaterials[s]; displayMaterials(filtered); } return; }
      const filtered = {};
      for (const subject in allMaterials) {
        const matching = allMaterials[subject].filter(item => { const fileName = (item.name||'').replace(/_/g,' ').toLowerCase(); return fileName.includes(query) || subject.toLowerCase().includes(query); });
        if (matching.length) filtered[subject] = matching;
      }
      if (Object.keys(filtered).length === 0) materialsList.innerHTML = `<p class="no-results">ğŸ” No materials found for "${query}"</p>`; else displayMaterials(filtered);
    }
  </script>

  <script>
    // Render grouped materials (items are {name, url})
    function displayMaterials(grouped) {
      materialsList.innerHTML = '';
      for (const subject in grouped) {
        const section = document.createElement('section');
        section.className = 'material-box';
        const heading = document.createElement('h2');
        heading.textContent = subject;
        section.appendChild(heading);
        grouped[subject].forEach(item => {
          const name = (item.name || '').replace(/_/g, ' ');
          const link = document.createElement('a');
          link.href = item.url || '#';
          link.textContent = 'ğŸ“„ ' + name;
          link.target = '_blank';
          link.className = 'download-btn';
          section.appendChild(link);
        });
        materialsList.appendChild(section);
      }
    }
  </script>
  </script>

  </head>
  <body>
    <header>
      <nav>
        <h2>ğŸ“˜ Study Hub</h2>
        <div class="nav-track">
          <a href="index.html">Home</a>
          <a href="materials.html" class="active">Materials</a>
          <a href="roadmap.html">ğŸ¯B.Tech Roadmap</a>
          <a href="about.html">About</a>
          <a href="contact.html">Contact</a>
        </div>
      </nav>
    </header>

    <main class="materials-container">
      <h1>ğŸ“š CSE Study Materials</h1>
      <div class="filter-buttons">
        <button class="filter-btn active" data-category="all">All Subjects</button>
        <button class="filter-btn" data-category="BEEC">BEEC</button>
        <button class="filter-btn" data-category="DM">Discrete Math</button>
        <button class="filter-btn" data-category="PSC">PSC</button>
        <button class="filter-btn" data-category="DSD">DSD</button>
      </div>

      <div class="search-container">
        <input type="text" id="search-bar" class="search-input" placeholder="ğŸ” Search materials by name or subject..." autocomplete="off" />
        <button id="clear-search" class="clear-btn" style="display:none">âœ•</button>
      </div>

      <div id="materials-list">
        <div class="loader-container">
          <div class="loader"></div>
          <p class="loader-text">Loading materials...</p>
        </div>
      </div>
    </main>

    <footer>
      <p>Â© 2025 Praveen Reddy | All rights reserved.</p>
    </footer>

  <!-- ğŸ’¬ Chatbase Chatbot -->
  <script>
    (function() {
      if (!window.chatbase || window.chatbase("getState") !== "initialized") {
        window.chatbase = (...args) => {
          if (!window.chatbase.q) { window.chatbase.q = [] }
          window.chatbase.q.push(args)
        };
        window.chatbase = new Proxy(window.chatbase, {
          get(target, prop) {
            if (prop === "q") return target.q;
            return (...a) => target(prop, ...a);
          }
        });
      }
      const onLoad = function() {
        const script = document.createElement("script");
        script.src = "https://www.chatbase.co/embed.min.js";
        script.id = "ZpkVlMr94rMHgyLpuyj8c"; // your Chatbase chatbot ID
        script.domain = "www.chatbase.co";
        document.body.appendChild(script);
      };
      if (document.readyState === "complete") onLoad();
      else window.addEventListener("load", onLoad);
    })();
  </script>

  <!-- Back to Top Button -->
  <button id="backToTop" title="Back to top">â†‘</button>

  <script>
    // Back to Top functionality
    const backToTopBtn = document.getElementById('backToTop');
    
    window.addEventListener('scroll', () => {
      if (window.pageYOffset > 300) {
        backToTopBtn.classList.add('show');
      } else {
        backToTopBtn.classList.remove('show');
      }
    });
    
    backToTopBtn.addEventListener('click', () => {
      window.scrollTo({
        top: 0,
        behavior: 'smooth'
      });
    });
  </script>
</body>
</html>
