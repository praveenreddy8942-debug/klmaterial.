<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
  import { getStorage, ref, listAll, getDownloadURL } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-storage.js";

  const firebaseConfig = {
    apiKey: "YOUR_API_KEY",
    authDomain: "cse-materials.firebaseapp.com",
    projectId: "cse-materials",
    storageBucket: "cse-materials.firebasestorage.app",
    messagingSenderId: "YOUR_ID",
    appId: "YOUR_APP_ID"
  };

  const app = initializeApp(firebaseConfig);
  const storage = getStorage(app);

  const materialsList = document.getElementById("materials-list");
  const storageRef = ref(storage);

  // üîπ Subject mapping
  const subjects = {
    "BEEC": "Basic Electrical & Electronic Circuits (BEEC)",
    "DM": "Discrete Mathematics (DM)",
    "DSD": "Digital System Design (DSD)",
    "CTSD": "C Programming & Software Design",
    "PSC": "Problem Solving Through C"  // use PSC instead of C
  };

  listAll(storageRef)
    .then((res) => {
      materialsList.innerHTML = "";
      const grouped = {};

      res.items.forEach((itemRef) => {
        const name = itemRef.name.toUpperCase();

        // Match only if filename starts with key + "-" (avoids false matches)
        const matchKey = Object.keys(subjects).find(
          key => name.startsWith(key + "-") || name.includes(key + "-CO")
        );

        const subject = matchKey ? subjects[matchKey] : "Other Materials";
        if (!grouped[subject]) grouped[subject] = [];
        grouped[subject].push(itemRef);
      });

      for (const subject in grouped) {
        const section = document.createElement("section");
        section.className = "material-box";
        section.innerHTML = `<h2>${subject}</h2>`;

        grouped[subject].forEach((itemRef) => {
          getDownloadURL(itemRef).then((url) => {
            const name = itemRef.name.replace(/_/g, " ");
            const link = document.createElement("a");
            link.href = url;
            link.textContent = "üìÑ " + name;
            link.target = "_blank";
            link.className = "download-btn";
            section.appendChild(link);
          });
        });

        materialsList.appendChild(section);
      }
    })
    .catch((error) => {
      console.error(error);
      materialsList.innerHTML = `<p>‚ö†Ô∏è Error loading materials. Check Firebase config or rules.</p>`;
    });
</script>
